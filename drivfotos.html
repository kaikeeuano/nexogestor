<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXO GESTOR - Drive Fotos</title>
    <link rel="stylesheet" href="staly.css">
    <script src="permissions.js"></script>
</head>
<body>
    <nav class="nav-list">
        <li class="nav-item"><a href="sitem.html">Dashboard</a></li>
        <li class="nav-item"><a href="gestao.html">Gest√£o</a></li>
        <li class="nav-item"><a href="agenda.html">Agenda</a></li>
        <li class="nav-item"><a href="projetos.html">Projetos</a></li>
        <li class="nav-item"><a href="membros.html">Membros</a></li>
        <li class="nav-item"><a href="relatorios.html">Relat√≥rios</a></li>
        <li class="nav-item"><a href="financeiro.html">Financeiro</a></li>
        <li class="nav-item"><a href="drivfotos.html" class="active">Fotos</a></li>
        <li class="nav-item"><a href="drivdoc.html">Documentos</a></li>
        <li class="nav-item"><a href="configuracao.html">Configura√ß√µes</a></li>
        <li class="nav-item"><button id="logout">Sair</button></li>
    </nav>
    
    <main class="drive">
        <h1>Drive de Fotos</h1>
        <div style="margin-bottom: 20px;">
            <button id="createFolder" style="padding: 15px 25px; font-size: 16px;">‚ûï Criar Nova Pasta</button>
        </div>
        <div id="foldersList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;"></div>
        <div id="folderView" style="display: none;">
            <button id="backToFolders">Voltar</button>
            <h2 id="folderTitle"></h2>
            <div id="uploadArea" class="upload-area">
                <p>Arraste e solte fotos aqui ou clique para selecionar</p>
                <input type="file" id="photoUpload" accept="image/*" multiple style="display: none;">
                <button id="selectFiles">Selecionar Arquivos</button>
            </div>
            <div id="previewArea" style="margin-top:12px; display:none;">
                <h3>Pr√©-visualiza√ß√£o</h3>
                <div id="previewGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(100px, 1fr)); gap:8px;"></div>
            </div>
            <div id="progressArea" style="display: none; margin-top:12px;">
                <p id="progressText">Enviando: 0/0</p>
                <div style="width:100%; background:#ddd; border-radius:4px; overflow:hidden;">
                    <div id="progressBar" style="height:20px; background:#4CAF50; width:0%; transition:width 0.3s;"></div>
                </div>
            </div>
            <button id="uploadPhotos" style="display: none;">Enviar Fotos</button>
            <button id="cancelUpload" style="display: none; background-color:#f44336;">Cancelar</button>
            <div id="filesList"></div>
        </div>
    </main>
    <script>
        const token = localStorage.getItem('token');
        const dashboardId = localStorage.getItem('dashboardId');
        let currentFolderId = null;
        let selectedFilesArray = [];
        let uploadInProgress = false;

        console.log('Page initialized - Token:', token ? token.substring(0, 20) + '...' : 'NOT FOUND', 'DashboardId:', dashboardId);

        if (!token || !dashboardId) {
            console.error('Missing token or dashboardId');
            alert('Erro: Token ou Dashboard n√£o encontrado. Fa√ßa login novamente.');
            window.location.href = 'login.html';
        } else {
            loadFolders();
            window.permissionManager.loadUserRole().then(() => {
                window.permissionManager.applyRestrictions('drivfotos');
            });
        }

        async function loadFolders() {
            try {
                console.log('Starting loadFolders...');
                const url = 'http://localhost:3000/folders?type=photos';
                const headers = { 
                    'Authorization': `Bearer ${token}`, 
                    'dashboard-id': dashboardId 
                };
                
                console.log('Fetching from:', url);
                console.log('Headers:', { 'dashboard-id': dashboardId });
                
                const response = await fetch(url, { headers });
                
                console.log('Response received - Status:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Folders load error:', response.status, errorText);
                    alert('‚ùå Erro ao carregar pastas (HTTP ' + response.status + '):\n' + errorText);
                    return;
                }
                
                const folders = await response.json();
                console.log('Folders loaded:', folders, 'count:', folders.length);
                const foldersList = document.getElementById('foldersList');
                foldersList.innerHTML = '';
                
                if (!folders || folders.length === 0) {
                    const emptyMsg = document.createElement('p');
                    emptyMsg.style.padding = '20px';
                    emptyMsg.style.textAlign = 'center';
                    emptyMsg.style.color = '#666';
                    emptyMsg.textContent = 'üìÅ Nenhuma pasta criada. Clique em "‚ûï Criar Nova Pasta" para come√ßar.';
                    foldersList.appendChild(emptyMsg);
                    console.log('No folders found');
                    return;
                }
                
                folders.forEach(folder => {
                    const div = document.createElement('div');
                    div.className = 'folder';
                    
                    const folderContent = document.createElement('div');
                    folderContent.style.width = '100%';
                    folderContent.style.cursor = 'pointer';
                    folderContent.addEventListener('click', () => {
                        console.log('Opening folder:', folder.id, folder.name);
                        openFolder(folder.id, folder.name);
                    });

                    const h3 = document.createElement('h3');
                    h3.textContent = folder.name;
                    folderContent.appendChild(h3);

                    const buttonsDiv = document.createElement('div');
                    buttonsDiv.style.marginTop = '12px';
                    buttonsDiv.style.display = 'flex';
                    buttonsDiv.style.gap = '8px';
                    buttonsDiv.style.justifyContent = 'center';
                    
                    const renameBtn = document.createElement('button');
                    renameBtn.textContent = '‚úèÔ∏è Renomear';
                    renameBtn.style.fontSize = '12px';
                    renameBtn.style.padding = '8px 12px';
                    renameBtn.style.backgroundColor = '#2196F3';
                    renameBtn.style.color = 'white';
                    renameBtn.style.border = 'none';
                    renameBtn.style.borderRadius = '4px';
                    renameBtn.style.cursor = 'pointer';
                    renameBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        renameFolder(folder.id, folder.name);
                    });

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'üóëÔ∏è Deletar';
                    deleteBtn.style.fontSize = '12px';
                    deleteBtn.style.padding = '8px 12px';
                    deleteBtn.style.backgroundColor = '#f44336';
                    deleteBtn.style.color = 'white';
                    deleteBtn.style.border = 'none';
                    deleteBtn.style.borderRadius = '4px';
                    deleteBtn.style.cursor = 'pointer';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteFolder(folder.id, folder.name);
                    });

                    buttonsDiv.appendChild(renameBtn);
                    buttonsDiv.appendChild(deleteBtn);
                    
                    div.appendChild(folderContent);
                    div.appendChild(buttonsDiv);

                    foldersList.appendChild(div);
                });
            } catch (err) {
                console.error('Error loading folders:', err);
                alert('Erro ao carregar pastas: ' + err.message);
            }
        }

        function openFolder(id, name) {
            currentFolderId = id;
            document.getElementById('folderTitle').textContent = name;
            document.getElementById('foldersList').style.display = 'none';
            document.getElementById('folderView').style.display = 'block';
            loadFiles();
        }

        async function renameFolder(id, oldName) {
            const newName = prompt('Novo nome da pasta:', oldName);
            if (!newName || newName === oldName) return;
            
            try {
                const response = await fetch(`http://localhost:3000/folders/${id}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${token}`,
                        'dashboard-id': dashboardId 
                    },
                    body: JSON.stringify({ name: newName })
                });
                
                if (response.ok) {
                    alert('‚úÖ Pasta renomeada com sucesso!');
                    loadFolders();
                } else {
                    const error = await response.json().catch(() => ({}));
                    alert('‚ùå Erro ao renomear pasta:\n' + (error.message || error.error || response.statusText));
                }
            } catch (err) {
                console.error('Rename failed:', err);
                alert('‚ùå Erro ao renomear pasta:\n' + err.message);
            }
        }

        async function deleteFolder(id, name) {
            if (!confirm(`Tem certeza que deseja deletar a pasta "${name}" e todos os arquivos nela?`)) {
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:3000/folders/${id}`, {
                    method: 'DELETE',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'dashboard-id': dashboardId 
                    }
                });
                
                if (response.ok) {
                    alert('‚úÖ Pasta deletada com sucesso!');
                    loadFolders();
                } else {
                    const error = await response.json().catch(() => ({}));
                    alert('‚ùå Erro ao deletar pasta:\n' + (error.message || error.error || response.statusText));
                }
            } catch (err) {
                console.error('Delete failed:', err);
                alert('‚ùå Erro ao deletar pasta:\n' + err.message);
            }
        }

        document.getElementById('backToFolders').addEventListener('click', () => {
            document.getElementById('folderView').style.display = 'none';
            document.getElementById('foldersList').style.display = 'block';
            currentFolderId = null;
        });

        document.getElementById('createFolder').addEventListener('click', async () => {
            const name = prompt('Nome da pasta:');
            if (!name) return;
            
            if (!token || !dashboardId) {
                alert('Erro: Token ou Dashboard n√£o dispon√≠vel. Fa√ßa login novamente.');
                window.location.href = 'login.html';
                return;
            }
            
            console.log('Creating folder:', name, 'with token:', token.substring(0, 20) + '...', 'dashboardId:', dashboardId);
            
            try {
                const response = await fetch('http://localhost:3000/folders', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${token}`, 
                        'dashboard-id': dashboardId 
                    },
                    body: JSON.stringify({ name, type: 'photos' })
                });
                
                console.log('Response status:', response.status, response.statusText);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Folder created:', result);
                    alert('‚úÖ Pasta "' + name + '" criada com sucesso!');
                    loadFolders();
                } else {
                    const error = await response.json().catch(() => ({}));
                    console.error('Folder creation error:', error);
                    alert('‚ùå Erro ao criar pasta:\n' + (error.message || error.error || response.statusText));
                }
            } catch (err) {
                console.error('Folder creation failed:', err);
                alert('‚ùå Erro ao criar pasta:\n' + err.message);
            }
        });

        async function loadFiles() {
            const response = await fetch(`http://localhost:3000/files?folder_id=${currentFolderId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const files = await response.json();
            const filesList = document.getElementById('filesList');
            filesList.innerHTML = '';
            
            if (files.length === 0) {
                const emptyMsg = document.createElement('p');
                emptyMsg.style.padding = '20px';
                emptyMsg.style.textAlign = 'center';
                emptyMsg.style.color = '#999';
                emptyMsg.textContent = 'üì∑ Nenhuma foto nesta pasta. Selecione e envie fotos acima.';
                filesList.appendChild(emptyMsg);
                return;
            }
            
            files.forEach(file => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'file';
                fileDiv.style.position = 'relative';
                fileDiv.style.padding = '10px';
                fileDiv.style.border = '1px solid #ddd';
                fileDiv.style.borderRadius = '4px';
                fileDiv.style.textAlign = 'center';

                const img = document.createElement('img');
                img.src = `/uploads/${file.filename}`;
                img.alt = file.name;
                img.style.width = '100px';
                img.style.height = '100px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '4px';

                const p = document.createElement('p');
                p.textContent = file.name.substring(0, 20);
                p.style.marginTop = '8px';
                p.style.fontSize = '12px';
                p.style.wordBreak = 'break-all';

                const btn = document.createElement('button');
                btn.textContent = 'üóëÔ∏è Deletar';
                btn.style.marginTop = '8px';
                btn.style.padding = '6px 10px';
                btn.style.fontSize = '11px';
                btn.style.backgroundColor = '#f44336';
                btn.style.color = 'white';
                btn.style.border = 'none';
                btn.style.borderRadius = '3px';
                btn.style.cursor = 'pointer';
                btn.addEventListener('click', async () => { 
                    if (confirm(`Deletar "${file.name}"?`)) {
                        await deleteFile(file.id);
                    }
                });

                fileDiv.appendChild(img);
                fileDiv.appendChild(p);
                fileDiv.appendChild(btn);

                filesList.appendChild(fileDiv);
            });
        }

        document.getElementById('selectFiles').addEventListener('click', () => {
            document.getElementById('photoUpload').click();
        });

        const uploadArea = document.getElementById('uploadArea');
        const photoUpload = document.getElementById('photoUpload');
        const uploadButton = document.getElementById('uploadPhotos');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            handleFiles(files);
        });

        photoUpload.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            if (files.length > 0) {
                if (!currentFolderId) {
                    alert('Por favor, selecione uma pasta antes de selecionar fotos.');
                    return;
                }
                selectedFilesArray = Array.from(files);
                uploadButton.style.display = 'block';
                uploadButton.textContent = `Enviar ${files.length} Foto(s)`;
                showPreview(selectedFilesArray);
            }
        }

        function showPreview(files) {
            const previewArea = document.getElementById('previewArea');
            const previewGrid = document.getElementById('previewGrid');
            previewGrid.innerHTML = '';
            files.forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.style.position = 'relative';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '100px';
                    img.style.height = '100px';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '4px';
                    const label = document.createElement('small');
                    label.textContent = file.name.substring(0, 15);
                    label.style.display = 'block';
                    label.style.fontSize = '10px';
                    label.style.marginTop = '4px';
                    div.appendChild(img);
                    div.appendChild(label);
                    previewGrid.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
            previewArea.style.display = 'block';
        }

        document.getElementById('uploadPhotos').addEventListener('click', async () => {
            if (selectedFilesArray.length === 0) {
                alert('Nenhuma foto selecionada.');
                return;
            }
            if (!currentFolderId) {
                alert('Por favor, selecione uma pasta antes de fazer upload.');
                return;
            }
            uploadInProgress = true;
            uploadButton.style.display = 'none';
            document.getElementById('cancelUpload').style.display = 'inline-block';
            const progressArea = document.getElementById('progressArea');
            progressArea.style.display = 'block';
            let completed = 0;
            const total = selectedFilesArray.length;
            const uploadPromises = selectedFilesArray.map(async (file) => {
                if (!uploadInProgress) return;
                const formData = new FormData();
                formData.append('file', file);
                formData.append('folder_id', currentFolderId);
                formData.append('name', file.name);
                try {
                    const resp = await fetch('http://localhost:3000/files', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });
                    if (resp.ok) {
                        completed++;
                        updateProgress(completed, total);
                    } else {
                        console.error('Upload error status:', resp.status, 'for file:', file.name);
                    }
                } catch (err) {
                    console.error('Upload failed for', file.name, err);
                }
            });
            await Promise.all(uploadPromises);
            if (uploadInProgress) {
                uploadInProgress = false;
                resetUploadUI();
                loadFiles();
            }
        });

        function updateProgress(completed, total) {
            const pct = (completed / total) * 100;
            document.getElementById('progressBar').style.width = pct + '%';
            document.getElementById('progressText').textContent = `Enviando: ${completed}/${total}`;
        }

        function resetUploadUI() {
            document.getElementById('photoUpload').value = '';
            const previewArea = document.getElementById('previewArea');
            const progressArea = document.getElementById('progressArea');
            const uploadBtn = document.getElementById('uploadPhotos');
            const cancelBtn = document.getElementById('cancelUpload');
            
            if (previewArea) previewArea.style.display = 'none';
            if (progressArea) progressArea.style.display = 'none';
            if (uploadBtn) uploadBtn.style.display = 'none';
            if (cancelBtn) cancelBtn.style.display = 'none';
            
            selectedFilesArray = [];
        }

        document.getElementById('cancelUpload').addEventListener('click', () => {
            uploadInProgress = false;
            resetUploadUI();
        });

        async function deleteFile(id) {
            try {
                const response = await fetch(`http://localhost:3000/files/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    console.log('File deleted successfully');
                    loadFiles();
                } else {
                    alert('‚ùå Erro ao deletar arquivo: ' + response.statusText);
                }
            } catch (err) {
                console.error('Delete file failed:', err);
                alert('‚ùå Erro ao deletar arquivo: ' + err.message);
            }
        }

        document.getElementById('logout').addEventListener('click', function() {
            localStorage.removeItem('token');
            localStorage.removeItem('dashboardId');
            window.location.href = 'login.html';
        });
    </script>