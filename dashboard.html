<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXO GESTOR - Dashboards</title>
    <link rel="stylesheet" href="staly.css">
</head>
<body>
    <main class="dashboards">
        <h1>Meus Dashboards</h1>
        <button id="createDashboard">Criar Novo Dashboard</button>
        <button id="joinDashboard">Entrar em Dashboard Existente</button>

        <section style="margin-top:14px; padding:12px; border:1px solid #ddd; border-radius:8px; background:#f7f9ff;">
            <h2>Crescimento por Per√≠odo</h2>
            <p>Acompanhe a evolu√ß√£o de membros e dashboards criando relat√≥rios por per√≠odo na p√°gina de membros. Use o filtro de datas e congrega√ß√£o para ver o total de ades√µes.</p>
        </section>
        
        <div id="createForm" style="display: none;">
            <h2>Criar Dashboard</h2>
            <input type="text" id="dashboardName" placeholder="Nome do Dashboard">
            <button id="submitCreate">Criar</button>
            <button id="cancelCreate">Cancelar</button>
        </div>
        
        <div id="joinForm" style="display: none;">
            <h2>Entrar em Dashboard</h2>
            <input type="text" id="joinCode" placeholder="C√≥digo do Dashboard">
            <button id="submitJoin">Entrar</button>
            <button id="cancelJoin">Cancelar</button>
        </div>
        
        <div id="dashboardList"></div>
    </main>

    <script>
        const API_BASE = 'http://localhost:3000';
        const token = localStorage.getItem('token');

        async function loadDashboards() {
            console.log('üîÑ Carregando dashboards...');
            console.log('Token:', token ? 'Presente' : 'Ausente');
            
            try {
                const response = await fetch(`${API_BASE}/dashboards`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                console.log('Resposta da API:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const dashboards = await response.json();
                console.log('Dashboards recebidos:', dashboards);
                
                const list = document.getElementById('dashboardList');
                list.innerHTML = '<h2>Dashboards Dispon√≠veis</h2>';
                
                if (!dashboards || dashboards.length === 0) {
                    list.innerHTML += '<p style="color:#666;padding:20px;text-align:center;">Nenhum dashboard encontrado. Crie um novo ou entre em um existente.</p>';
                    return;
                }
                
                dashboards.forEach(dashboard => {
                    const div = document.createElement('div');
                    div.className = 'dashboard-item';

                    const h3 = document.createElement('h3');
                    h3.textContent = dashboard.name;

                    const p = document.createElement('p');
                    p.textContent = `ID: ${dashboard.code || dashboard.id}`;

                    const btn = document.createElement('button');
                    btn.textContent = 'Acessar';
                    btn.addEventListener('click', () => selectDashboard(dashboard.id));

                    div.appendChild(h3);
                    div.appendChild(p);
                    div.appendChild(btn);

                    list.appendChild(div);
                });
                
                console.log('‚úÖ Dashboards carregados com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao carregar dashboards:', error);
                const list = document.getElementById('dashboardList');
                list.innerHTML = '<h2>Dashboards Dispon√≠veis</h2>';
                list.innerHTML += '<p style="color:red;padding:20px;text-align:center;">‚ùå Erro ao carregar dashboards. Verifique se o servidor est√° rodando.</p>';
                alert('Erro ao carregar dashboards: ' + error.message);
            }
        }

        document.getElementById('createDashboard').addEventListener('click', () => {
            document.getElementById('createForm').style.display = 'block';
            document.getElementById('joinForm').style.display = 'none';
        });

        document.getElementById('joinDashboard').addEventListener('click', () => {
            document.getElementById('joinForm').style.display = 'block';
            document.getElementById('createForm').style.display = 'none';
        });

        document.getElementById('submitCreate').addEventListener('click', async () => {
            const name = document.getElementById('dashboardName').value;
            
            if (!name.trim()) {
                alert('‚ö†Ô∏è Por favor, digite um nome para o dashboard');
                return;
            }
            
            console.log('üìù Criando dashboard:', name);
            
            try {
                const response = await fetch(`${API_BASE}/dashboards`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name })
                });
                
                console.log('Resposta:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Dashboard criado:', data);
                    alert(`‚úÖ Dashboard "${name}" criado com sucesso!\nC√≥digo: ${data.code}`);
                    localStorage.setItem('dashboardId', data.id);
                    window.location.href = 'sitem.html';
                } else {
                    const error = await response.json().catch(() => ({}));
                    console.error('‚ùå Erro:', error);
                    alert('‚ùå Erro ao criar dashboard: ' + (error.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('‚ùå Erro de conex√£o:', error);
                alert('‚ùå Erro ao conectar com o servidor');
            }
        });

        document.getElementById('submitJoin').addEventListener('click', async () => {
            const code = document.getElementById('joinCode').value;
            
            if (!code.trim()) {
                alert('‚ö†Ô∏è Por favor, digite o c√≥digo do dashboard');
                return;
            }
            
            console.log('üîë Entrando no dashboard com c√≥digo:', code);
            
            try {
                const response = await fetch(`${API_BASE}/dashboards/join`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ code })
                });
                
                console.log('Resposta:', response.status);
                
                if (response.ok) {
                    alert('‚úÖ Solicita√ß√£o enviada com sucesso! Aguarde aprova√ß√£o do dono do dashboard.');
                    document.getElementById('joinForm').style.display = 'none';
                    document.getElementById('joinCode').value = '';
                    await loadDashboards();
                } else {
                    const error = await response.json().catch(() => ({}));
                    console.error('‚ùå Erro:', error);
                    if (response.status === 404) {
                        alert('‚ùå Dashboard n√£o encontrado. Verifique o c√≥digo digitado.');
                    } else {
                        alert('‚ùå Erro ao entrar no dashboard: ' + (error.error || 'Erro desconhecido'));
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro de conex√£o:', error);
                alert('‚ùå Erro ao conectar com o servidor');
            }
        });

        document.getElementById('cancelCreate').addEventListener('click', () => {
            document.getElementById('createForm').style.display = 'none';
        });

        document.getElementById('cancelJoin').addEventListener('click', () => {
            document.getElementById('joinForm').style.display = 'none';
        });

        function selectDashboard(id) {
            localStorage.setItem('dashboardId', id);
            window.location.href = 'sitem.html';
        }

        if (!token) {
            window.location.href = 'login.html';
        } else {
            loadDashboards();
        }
    </script>
</body>
</html>