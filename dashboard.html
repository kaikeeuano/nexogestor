<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXO GESTOR - Dashboards</title>
    <link rel="stylesheet" href="staly.css">
    <script src="notifications.js"></script>
</head>
<body>
    <div style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
        <a href="index.html" style="display: flex; align-items: center; gap: 10px; text-decoration: none; color: white; transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            <span style="font-size: 28px;">üìä</span>
            <h2 style="margin: 0;">NEXO GESTOR</h2>
        </a>
        <div id="adminLink"></div>
    </div>
    
    <main class="dashboards">
        <h1>Meus Dashboards</h1>
        <button id="createDashboard" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">‚ú® Criar Novo Dashboard</button>
        <button id="joinDashboard">Entrar em Dashboard Existente</button>
        <button id="createPregacoes" style="background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); margin-top: 10px;">üìñ Criar Dashboard de Prega√ß√µes</button>

        <section style="margin-top:14px; padding:12px; border:1px solid #ddd; border-radius:8px; background:#f7f9ff;">
            <h2>üí° Dica</h2>
            <p>Crie seu pr√≥prio dashboard ou entre em um existente usando o c√≥digo de acesso. Para criar, voc√™ precisar√° de uma <strong>chave de ativa√ß√£o</strong> fornecida pelo administrador.</p>
        </section>
        
        <div id="createForm" style="display: none;">
            <h2>‚ú® Criar Novo Dashboard</h2>
            <input type="text" id="dashboardName" placeholder="Nome do Dashboard">
            <input type="text" id="activationKey" placeholder="Chave de Ativa√ß√£o (NEXO-XXXXXXXX-XXXXXXXX)" style="text-transform: uppercase; margin-top: 10px;">
            <button id="submitCreate">Criar Dashboard</button>
            <button id="cancelCreate">Cancelar</button>
        </div>
        
        <div id="createPregacoesForm" style="display: none;">
            <h2>üìñ Criar Dashboard de Prega√ß√µes</h2>
            <input type="text" id="pregacoesDashboardName" placeholder="Nome do Dashboard (ex: Minhas Prega√ß√µes)">
            <input type="text" id="pregacoesActivationKey" placeholder="Chave de Ativa√ß√£o (NEXO-XXXXXXXX-XXXXXXXX)" style="text-transform: uppercase; margin-top: 10px;">
            <button id="submitCreatePregacoes">Criar Dashboard de Prega√ß√µes</button>
            <button id="cancelCreatePregacoes">Cancelar</button>
        </div>
        
        <div id="joinForm" style="display: none;">
            <h2>Entrar em Dashboard</h2>
            <input type="text" id="joinCode" placeholder="C√≥digo do Dashboard">
            <button id="submitJoin">Entrar</button>
            <button id="cancelJoin">Cancelar</button>
        </div>
        

        
        <div id="dashboardList"></div>
    </main>

    <script>
        // Aguarda o DOM carregar completamente
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Dashboard.html carregado - DOMContentLoaded disparado!');
            console.log('üîç Verificando elementos...');
            console.log('Bot√£o createDashboard:', document.getElementById('createDashboard'));
            console.log('Bot√£o joinDashboard:', document.getElementById('joinDashboard'));
            console.log('Bot√£o createPregacoes:', document.getElementById('createPregacoes'));
            
            const API_BASE = 'http://localhost:3000';
            const token = localStorage.getItem('token');
            
            console.log('Token:', token ? 'Presente (' + token.substring(0, 20) + '...)' : 'AUSENTE - Redirecionando para login');

            // Verifica se o usu√°rio √© admin e mostra o link
            async function checkAdmin() {
                try {
                    const response = await fetch(`${API_BASE}/admin/check`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.isAdmin) {
                            document.getElementById('adminLink').innerHTML = 
                                '<a href="admin.html" style="color: white; text-decoration: none; padding: 8px 16px; background: rgba(255,255,255,0.2); border-radius: 6px; font-weight: 500;">‚öôÔ∏è Painel Admin</a>';
                        }
                    }
                } catch (error) {
                    console.log('N√£o √© admin');
                }
            }

            async function loadDashboards() {
            console.log('üîÑ Carregando dashboards...');
            console.log('Token:', token ? 'Presente' : 'Ausente');
            
            try {
                const response = await fetch(`${API_BASE}/dashboards`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                console.log('Resposta da API:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const dashboards = await response.json();
                console.log('Dashboards recebidos:', dashboards);
                
                const list = document.getElementById('dashboardList');
                list.innerHTML = '<h2>Dashboards Dispon√≠veis</h2>';
                
                if (!dashboards || dashboards.length === 0) {
                    list.innerHTML += '<p style="color:#666;padding:20px;text-align:center;">Nenhum dashboard encontrado. Crie um novo ou entre em um existente.</p>';
                    return;
                }
                
                dashboards.forEach(dashboard => {
                    const div = document.createElement('div');
                    div.className = 'dashboard-item';

                    const h3 = document.createElement('h3');
                    h3.textContent = dashboard.name;

                    const p = document.createElement('p');
                    p.textContent = `ID: ${dashboard.code || dashboard.id}`;

                    const buttonContainer = document.createElement('div');
                    buttonContainer.style.display = 'flex';
                    buttonContainer.style.gap = '10px';
                    buttonContainer.style.marginTop = '10px';

                    const btn = document.createElement('button');
                    btn.textContent = 'Acessar';
                    btn.addEventListener('click', () => selectDashboard(dashboard.id));

                    // Bot√£o de excluir (apenas para owner)
                    if (dashboard.status === 'owner') {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'üóëÔ∏è Excluir';
                        deleteBtn.style.backgroundColor = '#dc3545';
                        deleteBtn.style.color = 'white';
                        deleteBtn.addEventListener('click', () => deleteDashboard(dashboard.id, dashboard.name));
                        buttonContainer.appendChild(deleteBtn);
                    }

                    buttonContainer.appendChild(btn);

                    div.appendChild(h3);
                    div.appendChild(p);
                    div.appendChild(buttonContainer);

                    list.appendChild(div);
                });
                
                console.log('‚úÖ Dashboards carregados com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao carregar dashboards:', error);
                const list = document.getElementById('dashboardList');
                list.innerHTML = '<h2>Dashboards Dispon√≠veis</h2>';
                list.innerHTML += '<p style="color:red;padding:20px;text-align:center;">‚ùå Erro ao carregar dashboards. Verifique se o servidor est√° rodando.</p>';
                notify.error('Erro ao carregar dashboards. Verifique se o servidor est√° rodando.', { title: 'Erro de Conex√£o' });
            }
        }

        // Event Listeners para bot√µes principais
        function setupEventListeners() {
            console.log('üîß Configurando event listeners...');
            
            const createBtn = document.getElementById('createDashboard');
            const joinBtn = document.getElementById('joinDashboard');
            const pregacoesBtn = document.getElementById('createPregacoes');
            
            console.log('createBtn encontrado?', createBtn !== null);
            console.log('joinBtn encontrado?', joinBtn !== null);
            console.log('pregacoesBtn encontrado?', pregacoesBtn !== null);
            
            if (createBtn) {
                console.log('‚úÖ Adicionando listener ao createDashboard');
                createBtn.addEventListener('click', function() {
                    console.log('üéØ BOT√ÉO CRIAR DASHBOARD CLICADO!');
                    console.log('Mostrando formul√°rio de cria√ß√£o...');
                    document.getElementById('createForm').style.display = 'block';
                    document.getElementById('joinForm').style.display = 'none';
                    document.getElementById('createPregacoesForm').style.display = 'none';
                });
            } else {
                console.error('‚ùå Bot√£o createDashboard n√£o encontrado!');
            }

            if (joinBtn) {
                console.log('‚úÖ Adicionando listener ao joinDashboard');
                joinBtn.addEventListener('click', function() {
                    console.log('üéØ BOT√ÉO ENTRAR DASHBOARD CLICADO!');
                    document.getElementById('joinForm').style.display = 'block';
                    document.getElementById('createForm').style.display = 'none';
                    document.getElementById('createPregacoesForm').style.display = 'none';
                });
            } else {
                console.error('‚ùå Bot√£o joinDashboard n√£o encontrado!');
            }

            if (pregacoesBtn) {
                console.log('‚úÖ Adicionando listener ao createPregacoes');
                pregacoesBtn.addEventListener('click', function() {
                    console.log('üéØ BOT√ÉO CRIAR PREGA√á√ïES CLICADO!');
                    document.getElementById('createPregacoesForm').style.display = 'block';
                    document.getElementById('createForm').style.display = 'none';
                    document.getElementById('joinForm').style.display = 'none';
                });
            } else {
                console.error('‚ùå Bot√£o createPregacoes n√£o encontrado!');
            }
            
            // Submit Create Dashboard - REFEITO
            const submitCreateBtn = document.getElementById('submitCreate');
            if (submitCreateBtn) {
                console.log('‚úÖ Configurando bot√£o submitCreate');
                submitCreateBtn.onclick = async function() {
                    console.log('üöÄ INICIANDO CRIA√á√ÉO DE DASHBOARD');
                    
                    const nameInput = document.getElementById('dashboardName');
                    const keyInput = document.getElementById('activationKey');
                    
                    if (!nameInput || !keyInput) {
                        alert('Erro: Campos n√£o encontrados!');
                        return;
                    }
                    
                    const name = nameInput.value.trim();
                    const activationKey = keyInput.value.trim().toUpperCase();
                    
                    console.log('üìã Dados:', { name, activationKey, hasToken: !!token });
                    
                    if (!name) {
                        alert('Por favor, digite o nome do dashboard');
                        return;
                    }
                    
                    if (!activationKey) {
                        alert('Por favor, digite a chave de ativa√ß√£o');
                        return;
                    }
                    
                    if (!token) {
                        alert('Voc√™ n√£o est√° logado. Redirecionando...');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    try {
                        console.log('üì° Enviando requisi√ß√£o...');
                        const response = await fetch(`${API_BASE}/activate-dashboard`, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ activationKey: activationKey })
                        });
                        
                        console.log('üì• Resposta:', response.status, response.statusText);
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log('‚úÖ Sucesso:', data);
                            
                            if (data.dashboard && data.dashboard.id) {
                                // Atualizar nome
                                try {
                                    await fetch(`${API_BASE}/config`, {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${token}`,
                                            'dashboard-id': data.dashboard.id
                                        },
                                        body: JSON.stringify({ name: name })
                                    });
                                } catch (e) {
                                    console.warn('Erro ao atualizar nome:', e);
                                }
                                
                                alert(`Dashboard "${name}" criado com sucesso!\nC√≥digo: ${data.dashboard.code}`);
                                localStorage.setItem('dashboardId', data.dashboard.id);
                                window.location.href = 'sitem.html';
                            }
                        } else {
                            const error = await response.json().catch(() => ({ error: 'Erro desconhecido' }));
                            console.error('‚ùå Erro:', error);
                            alert('Erro: ' + (error.error || 'N√£o foi poss√≠vel criar o dashboard'));
                        }
                    } catch (error) {
                        console.error('‚ùå Exce√ß√£o:', error);
                        alert('Erro de conex√£o com o servidor. Verifique se est√° rodando.');
                    }
                };
            } else {
                console.error('‚ùå Bot√£o submitCreate n√£o encontrado!');
            }
            
            // Cancel Create - SIMPLIFICADO
            const cancelCreateBtn = document.getElementById('cancelCreate');
            if (cancelCreateBtn) {
                console.log('‚úÖ Configurando bot√£o cancelCreate');
                cancelCreateBtn.onclick = function() {
                    console.log('‚ùå Cancelando cria√ß√£o');
                    document.getElementById('createForm').style.display = 'none';
                    document.getElementById('dashboardName').value = '';
                    document.getElementById('activationKey').value = '';
                };
            }
            
            // Submit Create Pregacoes
            const submitPregacoesBtn = document.getElementById('submitCreatePregacoes');
            if (submitPregacoesBtn) {
                submitPregacoesBtn.addEventListener('click', async () => {
                    const name = document.getElementById('pregacoesDashboardName').value.trim();
                    const activationKey = document.getElementById('pregacoesActivationKey').value.trim().toUpperCase();
                    
                    if (!name) {
                        notify.warning('Por favor, digite o nome do dashboard', { title: 'Campo Obrigat√≥rio' });
                        return;
                    }
                    
                    if (!activationKey) {
                        notify.warning('Por favor, digite a chave de ativa√ß√£o', { title: 'Campo Obrigat√≥rio' });
                        return;
                    }
                    
                    const loadingId = notify.loading('Criando dashboard de prega√ß√µes...');
                    
                    try {
                        const response = await fetch(`${API_BASE}/activate-dashboard`, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ 
                                activationKey: activationKey
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            
                            // Atualiza o nome e tipo do dashboard
                            if (data.dashboard && data.dashboard.id) {
                                try {
                                    await fetch(`${API_BASE}/config`, {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${token}`,
                                            'dashboard-id': data.dashboard.id
                                        },
                                        body: JSON.stringify({ name: name, type: 'pregacoes' })
                                    });
                                } catch (err) {
                                    console.error('Erro ao atualizar dashboard:', err);
                                }
                            }
                            
                            notify.hide(loadingId);
                            notify.success(`Dashboard de Prega√ß√µes "${name}" criado com sucesso!`, { 
                                title: 'Dashboard Criado',
                                duration: 3000
                            });
                            localStorage.setItem('dashboardId', data.dashboard.id);
                            setTimeout(() => window.location.href = 'pregacoes.html?dashboardId=' + data.dashboard.id, 1500);
                        } else {
                            notify.hide(loadingId);
                            const error = await response.json().catch(() => ({}));
                            notify.error(error.error || 'Erro ao criar dashboard', { title: 'Erro' });
                        }
                    } catch (error) {
                        notify.hide(loadingId);
                        console.error('‚ùå Erro de conex√£o:', error);
                        notify.error('Erro ao conectar com o servidor', { title: 'Erro de Conex√£o' });
                    }
                });
            }
            
            // Cancel Create Pregacoes
            const cancelPregacoesBtn = document.getElementById('cancelCreatePregacoes');
            if (cancelPregacoesBtn) {
                cancelPregacoesBtn.addEventListener('click', () => {
                    document.getElementById('createPregacoesForm').style.display = 'none';
                    document.getElementById('pregacoesDashboardName').value = '';
                    document.getElementById('pregacoesActivationKey').value = '';
                });
            }
            
            // Submit Join
            const submitJoinBtn = document.getElementById('submitJoin');
            if (submitJoinBtn) {
                submitJoinBtn.addEventListener('click', async () => {
                    const code = document.getElementById('joinCode').value;
                    
                    if (!code.trim()) {
                        notify.warning('Por favor, digite o c√≥digo do dashboard', { title: 'Campo Obrigat√≥rio' });
                        return;
                    }
                    
                    console.log('üîë Entrando no dashboard com c√≥digo:', code);
                    
                    try {
                        const response = await fetch(`${API_BASE}/dashboards/join`, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ code })
                        });
                        
                        console.log('Resposta:', response.status);
                        
                        if (response.ok) {
                            notify.success('Solicita√ß√£o enviada! Aguarde aprova√ß√£o do dono do dashboard.', { 
                                title: 'Solicita√ß√£o Enviada',
                                duration: 6000
                            });
                            document.getElementById('joinForm').style.display = 'none';
                            document.getElementById('joinCode').value = '';
                            await loadDashboards();
                        } else {
                            const error = await response.json().catch(() => ({}));
                            console.error('‚ùå Erro:', error);
                            if (response.status === 404) {
                                notify.error('Dashboard n√£o encontrado. Verifique o c√≥digo digitado.', { title: 'N√£o Encontrado' });
                            } else {
                                notify.error(error.error || 'Erro desconhecido ao entrar no dashboard', { title: 'Erro' });
                            }
                        }
                    } catch (error) {
                        console.error('‚ùå Erro de conex√£o:', error);
                        notify.error('Erro ao conectar com o servidor', { title: 'Erro de Conex√£o' });
                    }
                });
            }
            
            // Cancel Join
            const cancelJoinBtn = document.getElementById('cancelJoin');
            if (cancelJoinBtn) {
                cancelJoinBtn.addEventListener('click', () => {
                    document.getElementById('joinForm').style.display = 'none';
                });
            }
        }

        // Chama a fun√ß√£o para configurar os event listeners
        setupEventListeners();

        function selectDashboard(id) {
            localStorage.setItem('dashboardId', id);
            window.location.href = 'sitem.html';
        }

        async function deleteDashboard(id, name) {
            if (!confirm(`Tem certeza que deseja excluir o dashboard "${name}"?\n\nEsta a√ß√£o n√£o pode ser desfeita e todos os dados ser√£o perdidos.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/dashboards/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    alert('Dashboard exclu√≠do com sucesso!');
                    await loadDashboards();
                } else {
                    const error = await response.json().catch(() => ({}));
                    alert(error.error || 'Erro ao excluir dashboard');
                }
            } catch (error) {
                console.error('Erro ao excluir dashboard:', error);
                alert('Erro ao conectar com o servidor');
            }
        }

        if (!token) {
            window.location.href = 'login.html';
        } else {
            checkAdmin();
            loadDashboards();
        }
        
        }); // Fim do DOMContentLoaded
    </script>
</body>
</html>
            
