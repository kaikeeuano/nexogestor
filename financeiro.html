<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXO GESTOR - Financeiro</title>
    <link rel="stylesheet" href="staly.css">
    <script src="permissions.js"></script>
    <style>
        /* Specific styles for financeiro page if not covered by staly.css */
        .summary-cards {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 200px;
            text-align: center;
        }
        .card h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 1rem;
        }
        .card .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }
        .card.income .value { color: #2ecc71; }
        .card.expense .value { color: #e74c3c; }
        .card.balance .value { color: #3498db; }

        .transaction-type {
            font-weight: bold;
        }
        .transaction-type.income { color: #2ecc71; }
        .transaction-type.expense { color: #e74c3c; }
        
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
    </style>
</head>
<body>
    <div style="padding: 15px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-bottom: 0;">
        <a href="index.html" style="display: flex; align-items: center; gap: 10px; text-decoration: none; color: white; width: fit-content; transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            <span style="font-size: 28px;">üí∞</span>
            <h2 style="margin: 0; font-size: 20px;">NEXO GESTOR</h2>
        </a>
    </div>
    <nav class="nav-list">
        <li class="nav-item"><a href="sitem.html">Dashboard</a></li>
        <li class="nav-item"><a href="gestao.html">gest√£o</a></li>
        <li class="nav-item"><a href="agenda.html">agenda</a></li>
        <li class="nav-item"><a href="projetos.html">projetos</a></li>
        <li class="nav-item"><a href="membros.html">membros</a></li>
        <li class="nav-item"><a href="relatorios.html">relat√≥rios</a></li>
        <li class="nav-item"><a href="financeiro.html">financeiro</a></li>
        <li class="nav-item"><a href="drivfotos.html">driv fotos</a></li>
        <li class="nav-item"><a href="drivdoc.html">driv doc</a></li>
        <li class="nav-item"><a href="configuracao.html">configura√ß√µes</a></li>
        <li class="nav-item"><button id="logout">Logout</button></li>
    </nav>
    
    <main class="financeiro">
        <h1>Contabilidade</h1>
        
        <div class="summary-cards">
            <div class="card balance">
                <h3>Saldo em Caixa</h3>
                <div class="value" id="totalBalance">R$ 0,00</div>
            </div>
            <div class="card income">
                <h3>Entradas (M√™s)</h3>
                <div class="value" id="monthIncome">R$ 0,00</div>
            </div>
            <div class="card expense">
                <h3>Sa√≠das (M√™s)</h3>
                <div class="value" id="monthExpense">R$ 0,00</div>
            </div>
        </div>

        <div class="actions">
            <button id="addIncomeBtn" style="background-color: #2ecc71;">Nova Entrada</button>
            <button id="addExpenseBtn" style="background-color: #e74c3c;">Nova Sa√≠da</button>
            <button id="printReportBtn" style="background-color: #3498db;">Imprimir Relat√≥rio</button>
        </div>

        <div class="filters">
            <label for="filterMonth">M√™s:</label>
            <select id="filterMonth">
                <option value="1">Janeiro</option>
                <option value="2">Fevereiro</option>
                <option value="3">Mar√ßo</option>
                <option value="4">Abril</option>
                <option value="5">Maio</option>
                <option value="6">Junho</option>
                <option value="7">Julho</option>
                <option value="8">Agosto</option>
                <option value="9">Setembro</option>
                <option value="10">Outubro</option>
                <option value="11">Novembro</option>
                <option value="12">Dezembro</option>
            </select>
            <select id="filterYear">
                <!-- Populated by JS -->
            </select>
        </div>
        
        <div id="printSection" style="display: none;">
            <div class="print-header" id="printHeaderContent">
                <!-- Header content populated dynamically -->
            </div>
            <div class="summary-cards" style="margin-bottom: 20px;">
                <div class="card balance">
                    <h3>Saldo em Caixa</h3>
                    <div class="value" id="printTotalBalance">R$ 0,00</div>
                </div>
                <div class="card income">
                    <h3>Entradas (M√™s)</h3>
                    <div class="value" id="printMonthIncome">R$ 0,00</div>
                </div>
                <div class="card expense">
                    <h3>Sa√≠das (M√™s)</h3>
                    <div class="value" id="printMonthExpense">R$ 0,00</div>
                </div>
            </div>
            <table id="printTable" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Descri√ß√£o</th>
                        <th>Categoria</th>
                        <th>Tipo</th>
                        <th>Valor</th>
                    </tr>
                </thead>
                <tbody id="printTableBody"></tbody>
            </table>
        </div>

        <table id="transactionsTable">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Descri√ß√£o</th>
                    <th>Categoria</th>
                    <th>Tipo</th>
                    <th>Valor</th>
                    <th>Anexo</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="transactionsBody"></tbody>
        </table>

        <!-- Modal -->
        <div id="transactionModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2 id="modalTitle">Nova Transa√ß√£o</h2>
                <form id="transactionForm">
                    <input type="hidden" id="transType">
                    
                    <label for="description">Descri√ß√£o:</label>
                    <input type="text" id="description" required>
                    
                    <label for="amount">Valor (R$):</label>
                    <input type="number" id="amount" step="0.01" min="0" required>
                    
                    <label for="date">Data:</label>
                    <input type="date" id="date" required>
                    
                    <label for="category">Categoria:</label>
                    <input type="text" id="category" placeholder="Ex: D√≠zimo, Luz, √Ågua">
                    
                    <label for="attachment">Anexo:</label>
                    <input type="file" id="attachment">

                    <div class="modal-actions">
                        <button type="button" id="submitTransaction">Salvar</button>
                        <button type="button" id="cancelTransaction">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script>
        const API_URL = 'http://localhost:3000/transactions';
        const CONFIG_URL = 'http://localhost:3000/config';
        const token = localStorage.getItem('token');
        const dashboardId = localStorage.getItem('dashboardId');
        let dashboardConfig = null;
        let allTransactions = []; // Store transactions for reporting

        if (!token || !dashboardId) {
            window.location.href = 'login.html';
        } else {
            loadConfig();
            // Apply permission restrictions
            window.permissionManager.loadUserRole().then(() => {
                window.permissionManager.applyRestrictions('financeiro');
            });
        }

        async function loadConfig() {
            try {
                const response = await fetch(CONFIG_URL, {
                    headers: { 'Authorization': `Bearer ${token}`, 'dashboard-id': dashboardId }
                });
                dashboardConfig = await response.json();
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        // Init date filters
        const today = new Date();
        const currentMonth = today.getMonth() + 1;
        const currentYear = today.getFullYear();
        
        document.getElementById('filterMonth').value = currentMonth;
        
        const yearSelect = document.getElementById('filterYear');
        for (let y = currentYear - 5; y <= currentYear + 1; y++) {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = y;
            if (y === currentYear) opt.selected = true;
            yearSelect.appendChild(opt);
        }

        loadTransactions();

        async function loadTransactions() {
            const month = document.getElementById('filterMonth').value;
            const year = document.getElementById('filterYear').value;
            
            // First load all transactions to calculate total balance (since balance is global, not just this month)
            // But for efficiency we might want to separate endpoints. 
            // For now, let's just fetch all to calculate balance, or we can trust the backend to give us a summary later.
            // Requirement: "valor do caixa" (Current cash balance)
            // If we filter by month, we can't calculate total balance correctly unless we have previous balance.
            // Let's fetch ALL transactions first to calculate balance, then filter for display?
            // Or better: Fetch all, calculate balance, then filter for the table view.
            
            try {
                const response = await fetch(`${API_URL}`, {
                    headers: { 'Authorization': `Bearer ${token}`, 'dashboard-id': dashboardId }
                });
                const transactions = await response.json();
                allTransactions = transactions; // Update global store
                
                calculateSummary(transactions, month, year);
                displayTransactions(transactions, month, year);
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        function calculateSummary(transactions, month, year) {
            let totalBalance = 0;
            let monthIncome = 0;
            let monthExpense = 0;

            transactions.forEach(t => {
                const amount = parseFloat(t.amount);
                if (t.type === 'income') {
                    totalBalance += amount;
                } else {
                    totalBalance -= amount;
                }

                // Check month/year for monthly stats
                const tDate = new Date(t.date);
                // Adjust for timezone if needed, but assuming simple date string YYYY-MM-DD
                // t.date is YYYY-MM-DD.
                const [tYear, tMonth, tDay] = t.date.split('-').map(Number);
                
                if (tYear == year && tMonth == month) {
                    if (t.type === 'income') monthIncome += amount;
                    else monthExpense += amount;
                }
            });

            document.getElementById('totalBalance').textContent = formatCurrency(totalBalance);
            document.getElementById('monthIncome').textContent = formatCurrency(monthIncome);
            document.getElementById('monthExpense').textContent = formatCurrency(monthExpense);
        }

        function displayTransactions(transactions, month, year) {
            const tbody = document.getElementById('transactionsBody');
            tbody.innerHTML = '';
            
            // Filter for display
            const filtered = transactions.filter(t => {
                const [tYear, tMonth] = t.date.split('-').map(Number);
                return tYear == year && tMonth == month;
            });

            filtered.forEach(t => {
                const row = document.createElement('tr');
                const amountClass = t.type === 'income' ? 'income' : 'expense';
                const typeLabel = t.type === 'income' ? 'Entrada' : 'Sa√≠da';
                const sign = t.type === 'income' ? '+' : '-';
                
                row.innerHTML = `
                    <td>${formatDate(t.date)}</td>
                    <td>${t.description}</td>
                    <td>${t.category || '-'}</td>
                    <td class="transaction-type ${amountClass}">${typeLabel}</td>
                    <td class="transaction-type ${amountClass}">${sign} ${formatCurrency(t.amount)}</td>
                    <td>${t.attachment ? `<a href="/uploads/${t.attachment}" target="_blank">Ver Anexo</a>` : '-'}</td>
                    <td>
                        <button onclick="deleteTransaction(${t.id})">Excluir</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        function formatDate(dateString) {
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }

        // Modal Functions
        function openModal(type) {
            const title = type === 'income' ? 'Nova Entrada' : 'Nova Sa√≠da';
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('transType').value = type;
            
            // Set date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            
            document.getElementById('transactionModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('transactionModal').style.display = 'none';
            document.getElementById('transactionForm').reset();
        }

        async function saveTransaction() {
            const type = document.getElementById('transType').value;
            const description = document.getElementById('description').value;
            const amount = document.getElementById('amount').value;
            const date = document.getElementById('date').value;
            const category = document.getElementById('category').value;
            const attachment = document.getElementById('attachment').files[0];

            if (!description || !amount || !date) {
                alert('Preencha os campos obrigat√≥rios.');
                return;
            }

            const formData = new FormData();
            formData.append('type', type);
            formData.append('description', description);
            formData.append('amount', amount);
            formData.append('date', date);
            formData.append('category', category);
            if (attachment) {
                formData.append('attachment', attachment);
            }

            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`, 
                        'dashboard-id': dashboardId
                        // 'Content-Type': 'multipart/form-data' // Do NOT set this manually when using FormData
                    },
                    body: formData
                });
                closeModal();
                loadTransactions();
            } catch (error) {
                console.error('Error saving transaction:', error);
                alert('Erro ao salvar transa√ß√£o.');
            }
        }

        async function deleteTransaction(id) {
            if (confirm('Tem certeza que deseja excluir esta transa√ß√£o?')) {
                await fetch(`${API_URL}/${id}`, { 
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}`, 'dashboard-id': dashboardId }
                });
                loadTransactions();
            }
        }

        // Event Listeners
        document.getElementById('addIncomeBtn').addEventListener('click', () => openModal('income'));
        document.getElementById('addExpenseBtn').addEventListener('click', () => openModal('expense'));
        document.getElementById('printReportBtn').addEventListener('click', printReport);
        document.getElementById('submitTransaction').addEventListener('click', saveTransaction);
        document.getElementById('cancelTransaction').addEventListener('click', closeModal);
        document.querySelector('.close').addEventListener('click', closeModal);
        
        document.getElementById('filterMonth').addEventListener('change', loadTransactions);
        document.getElementById('filterYear').addEventListener('change', loadTransactions);

        document.getElementById('logout').addEventListener('click', function() {
            localStorage.removeItem('token');
            localStorage.removeItem('dashboardId');
            window.location.href = 'login.html';
        });

        function printReport() {
            const month = document.getElementById('filterMonth').value;
            const year = document.getElementById('filterYear').value;
            
            // Filter transactions based on current selection
            const filtered = allTransactions.filter(t => {
                const [tYear, tMonth] = t.date.split('-').map(Number);
                return tYear == year && tMonth == month;
            });

            // Calculate summary for report
            let totalBalance = 0;
            let monthIncome = 0;
            let monthExpense = 0;

            // Global balance (from allTransactions)
            allTransactions.forEach(t => {
                const amount = parseFloat(t.amount);
                if (t.type === 'income') totalBalance += amount;
                else totalBalance -= amount;
            });

            // Monthly stats
            filtered.forEach(t => {
                const amount = parseFloat(t.amount);
                if (t.type === 'income') monthIncome += amount;
                else monthExpense += amount;
            });

            // Populate Print Section
            const header = document.getElementById('printHeaderContent');
            let logoHtml = '';
            if (dashboardConfig && dashboardConfig.logo) {
                logoHtml = `<img src="/uploads/${dashboardConfig.logo}" alt="Logo">`;
            }
            
            const monthName = document.getElementById('filterMonth').options[document.getElementById('filterMonth').selectedIndex].text;

            header.innerHTML = `
                ${logoHtml}
                <h2>${dashboardConfig ? dashboardConfig.name : 'Dashboard'}</h2>
                <h3>Relat√≥rio Financeiro</h3>
                <p><strong>Per√≠odo:</strong> ${monthName} de ${year}</p>
            `;

            document.getElementById('printTotalBalance').textContent = formatCurrency(totalBalance);
            document.getElementById('printMonthIncome').textContent = formatCurrency(monthIncome);
            document.getElementById('printMonthExpense').textContent = formatCurrency(monthExpense);

            const tbody = document.getElementById('printTableBody');
            tbody.innerHTML = '';
            filtered.forEach(t => {
                const tr = document.createElement('tr');
                const amountClass = t.type === 'income' ? 'income' : 'expense';
                const typeLabel = t.type === 'income' ? 'Entrada' : 'Sa√≠da';
                const sign = t.type === 'income' ? '+' : '-';

                tr.innerHTML = `
                    <td>${formatDate(t.date)}</td>
                    <td>${t.description}</td>
                    <td>${t.category || '-'}</td>
                    <td class="transaction-type ${amountClass}">${typeLabel}</td>
                    <td class="transaction-type ${amountClass}">${sign} ${formatCurrency(t.amount)}</td>
                `;
                tbody.appendChild(tr);
            });

            window.print();
        }
    </script>
</body>
</html>
